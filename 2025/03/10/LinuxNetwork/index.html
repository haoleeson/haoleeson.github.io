<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/my-avatar.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/my-favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/my-favicon-16x16.png">
  <link rel="mask-icon" href="/images/my-logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"haoleeson.cn","root":"/","images":"/images","scheme":"Muse","version":"8.7.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="本文记录一些工作中常用的Linux网络配置、排障、测试相关工具和指令。">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux Network">
<meta property="og:url" content="https://haoleeson.cn/2025/03/10/LinuxNetwork/index.html">
<meta property="og:site_name" content="Haoleeson&#39;s Notes">
<meta property="og:description" content="本文记录一些工作中常用的Linux网络配置、排障、测试相关工具和指令。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-03-10T08:33:45.000Z">
<meta property="article:modified_time" content="2025-03-10T08:33:45.000Z">
<meta property="article:author" content="haoleeson">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Network">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://haoleeson.cn/2025/03/10/LinuxNetwork/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://haoleeson.cn/2025/03/10/LinuxNetwork/","path":"2025/03/10/LinuxNetwork/","title":"Linux Network"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Linux Network | Haoleeson's Notes</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Haoleeson's Notes</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Record growth and enjoy life!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-landmark fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-cloud fa-fw"></i>云标签</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-hourglass-start fa-fw"></i>时间轴</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          目录
        </li>
        <li class="sidebar-nav-overview">
          概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E8%AE%BE%E7%BD%AE"><span class="nav-text">1. 设置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E5%88%9B%E5%BB%BA-veth-%E8%AE%BE%E5%A4%87%E5%AF%B9"><span class="nav-text">1.1. 创建 veth 设备对</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E5%88%9B%E5%BB%BA-Vxlan-Tunnel"><span class="nav-text">1.2. 创建 Vxlan Tunnel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E6%B7%BB%E5%8A%A0-x2F-%E5%88%A0%E9%99%A4-%E8%99%9A%E6%8B%9F%E7%BD%91%E5%8D%A1"><span class="nav-text">1.3. 添加&#x2F;删除 虚拟网卡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-%E6%B7%BB%E5%8A%A0%E5%88%A0%E9%99%A4%E7%BD%91%E6%A1%A5"><span class="nav-text">1.4. 添加删除网桥</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-%E4%BF%AE%E6%94%B9%E7%BD%91%E5%8D%A1-MAC-%E5%9C%B0%E5%9D%80"><span class="nav-text">1.5. 修改网卡 MAC 地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-%E9%85%8D%E7%BD%AE%E7%BD%91%E5%8D%A1-flow-hash-%E5%8F%82%E6%95%B0"><span class="nav-text">1.6. 配置网卡 flow-hash 参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-7-%E9%85%8D%E7%BD%AE%E7%BD%91%E5%8D%A1-offload-%E5%8F%82%E6%95%B0"><span class="nav-text">1.7. 配置网卡 offload 参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-8-%E9%87%8D%E5%90%AF%E7%BD%91%E5%8D%A1"><span class="nav-text">1.8. 重启网卡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-9-%E6%89%8B%E5%8A%A8-DHCP-%E7%94%B3%E8%AF%B7%E5%88%86%E9%85%8D-IP"><span class="nav-text">1.9. 手动 DHCP 申请分配 IP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-10-%E6%89%8B%E5%8A%A8%E6%9B%B4%E6%96%B0%E7%A7%9F%E7%BA%A6"><span class="nav-text">1.10. 手动更新租约</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-11-%E5%88%9B%E5%BB%BA%E7%BD%91%E7%BB%9C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%EF%BC%88network-namespaces%EF%BC%89"><span class="nav-text">1.11. 创建网络命名空间（network namespaces）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-12-%E9%98%B2%E7%81%AB%E5%A2%99%E9%85%8D%E7%BD%AE"><span class="nav-text">1.12. 防火墙配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-12-1-%E5%88%A0%E9%99%A4%E6%8C%87%E5%AE%9A%E8%A7%84%E5%88%99"><span class="nav-text">1.12.1. 删除指定规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-12-2-%E6%9F%A5%E7%9C%8B-POSTROUTING-%E8%A7%84%E5%88%99"><span class="nav-text">1.12.2. 查看 POSTROUTING 规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-12-3-%E6%9F%A5%E7%9C%8B-PREROUTING-%E8%A7%84%E5%88%99"><span class="nav-text">1.12.3. 查看 PREROUTING 规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-12-4-%E6%B7%BB%E5%8A%A0-DNAT-%E8%A7%84%E5%88%99"><span class="nav-text">1.12.4. 添加 DNAT 规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-12-5-%E9%98%B2%E7%81%AB%E5%A2%99%E4%B8%A2%E5%BC%83%E6%8C%87%E5%AE%9A%E7%9B%AE%E7%9A%84-mac-%E7%9A%84%E5%8C%85"><span class="nav-text">1.12.5. 防火墙丢弃指定目的 mac 的包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-12-6-%E9%98%B2%E7%81%AB%E5%A2%99%E6%B7%BB%E5%8A%A0-TCP%E3%80%81UDP-514-%E7%AB%AF%E5%8F%A3"><span class="nav-text">1.12.6. 防火墙添加 TCP、UDP 514 端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-12-7-%E6%B7%BB%E5%8A%A0-%E6%94%AF%E6%8C%81%E6%8E%A5%E6%94%B6-VxLAN-udp-%E6%8A%A5%E6%96%87%E8%A7%84%E5%88%99"><span class="nav-text">1.12.7. 添加 支持接收 VxLAN udp 报文规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-12-8-%E9%98%B2%E7%81%AB%E5%A2%99-CentOs-%E5%BC%80%E5%90%AF%E7%AB%AF%E5%8F%A3"><span class="nav-text">1.12.8. 防火墙 CentOs 开启端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-12-9-%E5%A4%87%E4%BB%BD%E9%98%B2%E7%81%AB%E5%A2%99%E9%85%8D%E7%BD%AE%E5%88%B0%E6%96%87%E4%BB%B6"><span class="nav-text">1.12.9. 备份防火墙配置到文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-13-%E8%AF%81%E4%B9%A6"><span class="nav-text">1.13. 证书</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-13-1-%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6"><span class="nav-text">1.13.1. 生成证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-13-2-%E6%9F%A5%E7%9C%8B%E8%AF%81%E4%B9%A6%E4%BF%A1%E6%81%AF"><span class="nav-text">1.13.2. 查看证书信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-13-3-%E6%9F%A5%E7%9C%8B%E7%8E%AF%E5%A2%83%E6%94%AF%E6%8C%81-openssl-%E8%AF%81%E4%B9%A6"><span class="nav-text">1.13.3. 查看环境支持 openssl 证书</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-14-%E8%AE%BE%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%99%A8DNS"><span class="nav-text">1.14. 设置服务器DNS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-15-%E6%B7%BB%E5%8A%A0-apt-%E6%BA%90"><span class="nav-text">1.15. 添加 apt 源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-16-%E6%9B%B4%E6%96%B0-apt-source-list"><span class="nav-text">1.16. 更新 apt-source-list</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-17-%E6%B7%BB%E5%8A%A0%E9%9D%99%E6%80%81DNS%E8%A7%A3%E6%9E%90%E5%92%8C%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1"><span class="nav-text">1.17. 添加静态DNS解析和静态路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-18-%E5%AE%89%E8%A3%85-Apache2-%E7%BD%91%E9%A1%B5"><span class="nav-text">1.18. 安装 Apache2 网页</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-19-%E8%A7%A3%E5%86%B3-SSH-%E8%87%AA%E5%8A%A8%E6%96%AD%E8%BF%9E%E9%97%AE%E9%A2%98"><span class="nav-text">1.19. 解决 SSH 自动断连问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-20-%E5%88%A0%E9%99%A4%E5%B7%B2%E7%9F%A5-HOST"><span class="nav-text">1.20. 删除已知 HOST</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E6%8E%92%E9%9A%9C"><span class="nav-text">2. 排障</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E6%9F%A5%E7%9C%8B%E7%BD%91%E5%8F%A3%E4%BF%A1%E6%81%AF%EF%BC%88speed%EF%BC%89"><span class="nav-text">2.1. 查看网口信息（speed）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E6%9F%A5%E7%9C%8B%E7%BD%91%E5%8D%A1%E5%9E%8B%E5%8F%B7"><span class="nav-text">2.2. 查看网卡型号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E6%9F%A5%E7%9C%8B%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8"><span class="nav-text">2.3. 查看端口占用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E6%9F%A5%E7%9C%8B%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3%E7%9A%84%E5%BB%BA%E9%93%BE%E6%95%B0"><span class="nav-text">2.4. 查看指定端口的建链数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-%E6%9F%A5%E7%9C%8B-ssh-%E7%99%BB%E5%BD%95%E5%9C%A8%E7%BA%BF%E4%BA%BA%E6%95%B0"><span class="nav-text">2.5. 查看 ssh 登录在线人数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-6-%E6%89%8B%E5%8A%A8%E8%8E%B7%E5%8F%96-DHCP-ip"><span class="nav-text">2.6. 手动获取 DHCP ip</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-7-%E6%9F%A5%E7%9C%8B%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81"><span class="nav-text">2.7. 查看网络服务状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-8-%E6%9F%A5%E7%9C%8B%E7%BD%91%E5%8D%A1%E6%95%B0%E6%8D%AE"><span class="nav-text">2.8. 查看网卡数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-9-%E6%9F%A5%E7%9C%8B%E7%BD%91%E5%8D%A1-MAC-%E5%9C%B0%E5%9D%80"><span class="nav-text">2.9. 查看网卡 MAC 地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-10-%E7%BD%91%E5%8D%A1%E4%B8%8D%E8%83%BD%E6%AD%A3%E5%B8%B8-UP-%E5%AE%9A%E4%BD%8D"><span class="nav-text">2.10. 网卡不能正常 UP 定位</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-11-%E6%8A%93%E5%8C%85"><span class="nav-text">2.11. 抓包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-12-TFTP%E4%BC%A0%E8%BE%93"><span class="nav-text">2.12. TFTP传输</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-13-SFTP%E4%BC%A0%E8%BE%93"><span class="nav-text">2.13. SFTP传输</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-14-SCP%E4%BC%A0%E8%BE%93"><span class="nav-text">2.14. SCP传输</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-15-curl"><span class="nav-text">2.15. curl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-16-%E6%9F%A5%E7%9C%8B-Linux-TCP-keepalive-%E9%85%8D%E7%BD%AE"><span class="nav-text">2.16. 查看 Linux TCP keepalive 配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E6%B5%8B%E8%AF%95"><span class="nav-text">3. 测试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E7%BD%91%E7%BB%9C%E6%B5%8B%E9%80%9F%E5%B7%A5%E5%85%B7-iperf"><span class="nav-text">3.1. 网络测速工具 iperf</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-%E5%BC%80%E5%90%AF%E9%98%B2%E7%81%AB%E5%A2%99-5001-%E7%AB%AF%E5%8F%A3-iperf2-%E9%BB%98%E8%AE%A4-5001-iperf3-%E9%BB%98%E8%AE%A4-5201"><span class="nav-text">3.1.1. 开启防火墙 5001 端口(iperf2 默认 5001, iperf3 默认 5201)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-TCP-%E6%B5%8B%E8%AF%95"><span class="nav-text">3.1.2. TCP 测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-3-UDP%E6%B5%8B%E8%AF%95"><span class="nav-text">3.1.3. UDP测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E5%AE%89%E8%A3%85qume%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="nav-text">3.2. 安装qume虚拟机</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E8%A7%A3%E6%9E%90%E8%AE%BE%E5%A4%87-IP"><span class="nav-text">3.3. 解析设备 IP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-Scapy"><span class="nav-text">3.4. Scapy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-1-%E6%9F%A5%E7%9C%8B%E8%AE%BE%E5%A4%87%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3"><span class="nav-text">3.4.1. 查看设备网络接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-2-%E6%9F%A5%E7%9C%8B%E8%B7%AF%E7%94%B1"><span class="nav-text">3.4.2. 查看路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-3-%E6%9F%A5%E7%9C%8B%E6%9F%90%E6%8E%A5%E5%8F%A3-IP-x2F-MAC"><span class="nav-text">3.4.3. 查看某接口 IP&#x2F;MAC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-4-%E7%AE%80%E5%8D%95-demo"><span class="nav-text">3.4.4. 简单 demo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-5-%E6%9E%84%E9%80%A0%E6%8A%A5%E6%96%87%EF%BC%88%E8%AE%A1%E7%AE%97%E6%A0%A1%E9%AA%8C%E5%92%8C%E6%96%B9%E5%BC%8F-1%EF%BC%89"><span class="nav-text">3.4.5. 构造报文（计算校验和方式 1）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-6-%E6%9E%84%E9%80%A0%E6%8A%A5%E6%96%87%EF%BC%88%E8%AE%A1%E7%AE%97%E6%A0%A1%E9%AA%8C%E5%92%8C%E6%96%B9%E5%BC%8F-2%EF%BC%89"><span class="nav-text">3.4.6. 构造报文（计算校验和方式 2）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-7-%E5%8F%91%E5%8C%85-x2F-%E6%94%B6%E5%8C%85"><span class="nav-text">3.4.7. 发包&#x2F;收包</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-7-1-%E4%BA%8C%E5%B1%82%E5%8F%91%E5%8C%85%EF%BC%8C%E6%8C%87%E5%AE%9A%E5%87%BA%E6%8E%A5%E5%8F%A3"><span class="nav-text">3.4.7.1. 二层发包，指定出接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-7-2-%E6%99%AE%E9%80%9A%E6%94%B6%E5%8F%91%E5%8C%85"><span class="nav-text">3.4.7.2. 普通收发包</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-8-%E5%97%85%E6%8E%A2"><span class="nav-text">3.4.8. 嗅探</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="haoleeson"
      src="/images/my-avatar.png">
  <p class="site-author-name" itemprop="name">haoleeson</p>
  <div class="site-description" itemprop="description">记录成长，享受生活！</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">92</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">主题</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">关键词</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/haoleeson" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;haoleeson" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Friendly links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://reuixiy.github.io/" title="https:&#x2F;&#x2F;reuixiy.github.io&#x2F;" rel="noopener" target="_blank">reuixiy</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://notes.iissnan.com/" title="https:&#x2F;&#x2F;notes.iissnan.com&#x2F;" rel="noopener" target="_blank">IIssNan</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://sunxiaohang.github.io/" title="https:&#x2F;&#x2F;sunxiaohang.github.io&#x2F;" rel="noopener" target="_blank">sunxiaohang</a>
        </li>
    </ul>
  </div>

          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://haoleeson.cn/2025/03/10/LinuxNetwork/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/my-avatar.png">
      <meta itemprop="name" content="haoleeson">
      <meta itemprop="description" content="记录成长，享受生活！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Haoleeson's Notes">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux Network
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">编写</span>

      <time title="创建：2025-03-10 16:33:45" itemprop="dateCreated datePublished" datetime="2025-03-10T16:33:45+08:00">2025-03-10</time>
    </span>

  
    <span id="/2025/03/10/LinuxNetwork/" class="post-meta-item leancloud_visitors" data-flag-title="Linux Network" title="浏览">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">浏览：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>本文记录一些工作中常用的Linux网络配置、排障、测试相关工具和指令。</p>
<a id="more"></a>

<h1 id="1-设置"><a href="#1-设置" class="headerlink" title="1. 设置"></a>1. 设置</h1><h2 id="1-1-创建-veth-设备对"><a href="#1-1-创建-veth-设备对" class="headerlink" title="1.1. 创建 veth 设备对"></a>1.1. 创建 veth 设备对</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建设备对 veth0 和 veth1</span></span><br><span class="line">ip link add name veth0 type veth peer name veth1</span><br><span class="line"><span class="meta">#</span><span class="bash"> check</span></span><br><span class="line">ip link show veth0</span><br><span class="line">ip link show veth1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">set</span> mtu</span></span><br><span class="line">ip link set mtu 9000 veth0 up</span><br><span class="line">ip link set mtu 9000 veth1 up</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加一个 veth 口到指定容器中</span></span><br><span class="line">container_pid=$(sudo docker inspect --format=&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27; manager_container1)</span><br><span class="line"><span class="meta">#</span><span class="bash"> ip link <span class="built_in">set</span> netns <span class="variable">$&#123;container_pid&#125;</span> dev vethx &amp;&amp; ip netns <span class="built_in">exec</span> <span class="variable">$&#123;container_pid&#125;</span> ip link <span class="built_in">set</span> name eth1 dev vethy</span></span><br><span class="line">ip link set netns $&#123;container_pid&#125; dev veth$&#123;y&#125; &amp;&amp; docker exec -i $container_name ip link set name eth1 dev veth$&#123;y&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建 veth 设备对，加入 container</span></span><br><span class="line">/Users/bytedance/code/myShell/create_veth_into_container.sh</span><br></pre></td></tr></table></figure>

<h2 id="1-2-创建-Vxlan-Tunnel"><a href="#1-2-创建-Vxlan-Tunnel" class="headerlink" title="1.2. 创建 Vxlan Tunnel"></a>1.2. 创建 Vxlan Tunnel</h2><p>从指定 eth 网口创建</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> PS： 添加 IP</span></span><br><span class="line">sudo ip addr add 10.1.1.1/31 dev eth4</span><br><span class="line">sudo ip addr del 10.20.30.40/31 dev eth4</span><br><span class="line"></span><br><span class="line">ip link add &lt;vxlan_name&gt; type vxlan id &lt;vni&gt; dstport 4789 remote &lt;dst_vtep&gt; local &lt;src_vtep&gt; dev &lt;interface_name&gt;</span><br><span class="line">ip link add vxlan12345 type vxlan id 12345 dstport 4789 remote 10.20.30.40 local 192.168.1.2 dev eth4</span><br><span class="line">ip link add vxlan3511 type vxlan id 3511 dstport 4789 remote 10.1.1.2 local 10.1.1.1 dev eth4</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ignore_checksum (vxlan 外层 udp checksum 为 0 时不会被 Linux 协议栈丢弃)</span></span><br><span class="line">ip link add &lt;vxlan_name&gt; type vxlan id &lt;vni&gt; udp6zerocsumrx dstport 4789 remote &lt;dst_vtep&gt; local &lt;src_vtep&gt; dev &lt;interface_name&gt;</span><br><span class="line">ip link add vxlan12345 type vxlan id 12345 udp6zerocsumrx dstport 4789 remote 10.20.30.40 local 192.168.1.2 dev eth4</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> check</span></span><br><span class="line">ip link | grep vxlan</span><br><span class="line">ip -d link show &lt;vxlan_name&gt;</span><br><span class="line">ip -d link show vxlan12345</span><br><span class="line">ip -d link show vxlan700</span><br><span class="line">ip -d link show vxlan701</span><br><span class="line">ip -d link show vxlan3511</span><br><span class="line">ip -d link show vxlan500</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> PS: delete a vxlan</span></span><br><span class="line">sudo ip link delete vxlan700</span><br><span class="line">sudo ip link delete vxlan701</span><br><span class="line">sudo ip link delete vxlan3511</span><br></pre></td></tr></table></figure>

<h2 id="1-3-添加-x2F-删除-虚拟网卡"><a href="#1-3-添加-x2F-删除-虚拟网卡" class="headerlink" title="1.3. 添加&#x2F;删除 虚拟网卡"></a>1.3. 添加&#x2F;删除 虚拟网卡</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建</span></span><br><span class="line">sudo ifconfig eth0:0 192.168.1.63 up</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除</span></span><br><span class="line">sudo ifconfig eth0:0 down</span><br></pre></td></tr></table></figure>

<h2 id="1-4-添加删除网桥"><a href="#1-4-添加删除网桥" class="headerlink" title="1.4. 添加删除网桥"></a>1.4. 添加删除网桥</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 添加网桥 br1</span></span><br><span class="line">brctl addbr br1</span><br><span class="line">ifconfig br1 10.250.0.1/24</span><br><span class="line">ifconfig br1 inet6 add fec0::1/64</span><br><span class="line">ifconfig br1 up</span><br><span class="line">brctl show br1</span><br><span class="line">ifconfig br1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除网桥 br1</span></span><br><span class="line">brctl show br1</span><br><span class="line">ifconfig br1 down</span><br><span class="line">brctl delbr br1</span><br></pre></td></tr></table></figure>

<h2 id="1-5-修改网卡-MAC-地址"><a href="#1-5-修改网卡-MAC-地址" class="headerlink" title="1.5. 修改网卡 MAC 地址"></a>1.5. 修改网卡 MAC 地址</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ip a s eth1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ping -I eth1 -c 10 172.16.1.1</span></span><br><span class="line">ifconfig eth1 down</span><br><span class="line"><span class="meta">#</span><span class="bash"> ifconfig eth1 hw ether 00:04:00:04:04:04</span></span><br><span class="line">ifconfig eth1 hw ether 00:03:00:03:03:03</span><br><span class="line"><span class="meta">#</span><span class="bash"> ifconfig eth1 hw ether 00:56:00:56:56:56</span></span><br><span class="line">ifconfig eth1 up</span><br><span class="line">ip a s eth1</span><br></pre></td></tr></table></figure>

<h2 id="1-6-配置网卡-flow-hash-参数"><a href="#1-6-配置网卡-flow-hash-参数" class="headerlink" title="1.6. 配置网卡 flow-hash 参数"></a>1.6. 配置网卡 flow-hash 参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ethtool -N eth5 rx-flow-hash udp4 sd</span><br><span class="line">ethtool -N eth5 rx-flow-hash tcp4 sd</span><br><span class="line">ethtool -N eth5 rx-flow-hash udp4 sdfn</span><br><span class="line">ethtool -N eth5 rx-flow-hash tcp4 sdfn</span><br></pre></td></tr></table></figure>

<h2 id="1-7-配置网卡-offload-参数"><a href="#1-7-配置网卡-offload-参数" class="headerlink" title="1.7. 配置网卡 offload 参数"></a>1.7. 配置网卡 offload 参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ethtool -K eth0 rx-checksum on|off</span><br><span class="line">ethtool -K eth0 tx-checksum-ip-generic on|off</span><br><span class="line">ethtool -K eth0 tso on|off</span><br><span class="line">ethtool -K eth0 ufo on | off</span><br><span class="line">ethtool -K eth0 gso on | off</span><br><span class="line">ethtool -K eth0 ntuple on | off</span><br></pre></td></tr></table></figure>

<h2 id="1-8-重启网卡"><a href="#1-8-重启网卡" class="headerlink" title="1.8. 重启网卡"></a>1.8. 重启网卡</h2><blockquote>
<p>静态 IP 配置文件 &#x2F;etc&#x2F;network&#x2F;interfaces</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> a. 重启网络：</span></span><br><span class="line">sudo /etc/init.d/networking restart</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或</span></span><br><span class="line">sudo service networking restart</span><br><span class="line"><span class="meta">#</span><span class="bash"> b. 重启网卡（eg. eth0）：</span></span><br><span class="line">sudo ifdown eth0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或</span></span><br><span class="line">sudo ifup eth0</span><br></pre></td></tr></table></figure>

<h2 id="1-9-手动-DHCP-申请分配-IP"><a href="#1-9-手动-DHCP-申请分配-IP" class="headerlink" title="1.9. 手动 DHCP 申请分配 IP"></a>1.9. 手动 DHCP 申请分配 IP</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/dhclient eth0</span><br></pre></td></tr></table></figure>

<h2 id="1-10-手动更新租约"><a href="#1-10-手动更新租约" class="headerlink" title="1.10. 手动更新租约"></a>1.10. 手动更新租约</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/sbin/ifconfig /renew</span><br><span class="line">/sbin/ifconfig /release</span><br></pre></td></tr></table></figure>

<h2 id="1-11-创建网络命名空间（network-namespaces）"><a href="#1-11-创建网络命名空间（network-namespaces）" class="headerlink" title="1.11. 创建网络命名空间（network namespaces）"></a>1.11. 创建网络命名空间（network namespaces）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看当前网络命名空间</span></span><br><span class="line">sudo ip netns list</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建网络命名空间</span></span><br><span class="line">sudo ip netns add defaultns</span><br><span class="line">sudo ip netns add eth4ns</span><br><span class="line">sudo ip netns add eth5ns</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在网络命名空间中创建虚拟网络空间，并绑定实际网卡</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ip link add link &lt;real_interface&gt; &lt;virtual_interface&gt; netns &lt;namespace&gt; <span class="built_in">type</span> ipvlan mode l2</span></span><br><span class="line">sudo ip link add link eth4 eth4_vns netns eth4ns type ipvlan mode l2</span><br><span class="line">sudo ip link add link eth5 eth5_vns netns eth5ns type ipvlan mode l2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置虚拟网络空间</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 开启虚拟网络空间</span></span></span><br><span class="line">sudo ip -n eth4ns link set lo up</span><br><span class="line">sudo ip -n eth4ns link set eth4_vns up</span><br><span class="line">sudo ip -n eth5ns link set lo up</span><br><span class="line">sudo ip -n eth5ns link set eth5_vns up</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 配置 IP 和 Route</span></span></span><br><span class="line">sudo ip -n eth4ns addr add 10.0.0.2/24 dev eth4_vns</span><br><span class="line">sudo ip -n eth4ns route add default via 10.0.0.1 dev eth4_vns</span><br><span class="line">sudo ip netns exec eth4ns ip route add 20.0.0.5 via 10.0.0.5</span><br><span class="line">sudo ip -n eth5ns addr add 20.0.0.2/24 dev eth5_vns</span><br><span class="line">sudo ip -n eth5ns route add default via 20.0.0.1 dev eth5_vns</span><br><span class="line">sudo ip netns exec eth5ns ip route add 10.0.0.5 via 20.0.0.5</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 命名空间执行命令</span></span><br><span class="line">sudo ip netns exec eth4ns ip route list</span><br><span class="line">sudo ip netns exec eth5ns ip route list</span><br><span class="line"></span><br><span class="line">sudo ip netns exec eth4ns ping 10.0.0.5</span><br><span class="line">sudo ip netns exec eth4ns ping 20.0.0.5</span><br><span class="line"></span><br><span class="line">sudo ip netns exec eth5ns ping 20.0.0.5</span><br><span class="line">sudo ip netns exec eth5ns ping 10.0.0.5</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除网络命名空间</span></span><br><span class="line">sudo ip netns delete eth4ns</span><br><span class="line">sudo ip netns delete eth5ns</span><br></pre></td></tr></table></figure>

<h2 id="1-12-防火墙配置"><a href="#1-12-防火墙配置" class="headerlink" title="1.12. 防火墙配置"></a>1.12. 防火墙配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看入方向规则</span></span><br><span class="line">sudo iptables -nvL INPUT</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看出方向规则</span></span><br><span class="line">sudo iptables -nvL OUTPUT</span><br></pre></td></tr></table></figure>
<h3 id="1-12-1-删除指定规则"><a href="#1-12-1-删除指定规则" class="headerlink" title="1.12.1. 删除指定规则"></a>1.12.1. 删除指定规则</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -L --line-numbers</span><br><span class="line"><span class="meta">#</span><span class="bash"> e.g. 删除 INPUT 表中的第 3 条规则</span></span><br><span class="line">sudo iptables -D INPUT 3</span><br></pre></td></tr></table></figure>

<h3 id="1-12-2-查看-POSTROUTING-规则"><a href="#1-12-2-查看-POSTROUTING-规则" class="headerlink" title="1.12.2. 查看 POSTROUTING 规则"></a>1.12.2. 查看 POSTROUTING 规则</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -v -L POSTROUTING -n --line-number</span><br><span class="line">iptables -t nat -D POSTROUTING num</span><br></pre></td></tr></table></figure>
<h3 id="1-12-3-查看-PREROUTING-规则"><a href="#1-12-3-查看-PREROUTING-规则" class="headerlink" title="1.12.3. 查看 PREROUTING 规则"></a>1.12.3. 查看 PREROUTING 规则</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -v -L PREROUTING -n --line-number</span><br><span class="line">iptables -t nat -D PREROUTING num</span><br></pre></td></tr></table></figure>

<h3 id="1-12-4-添加-DNAT-规则"><a href="#1-12-4-添加-DNAT-规则" class="headerlink" title="1.12.4. 添加 DNAT 规则"></a>1.12.4. 添加 DNAT 规则</h3><ul>
<li><p>IPv4</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 设置变量</span></span><br><span class="line">TESTBED_SERVER_IP=&#x27;10.201.40.80&#x27;</span><br><span class="line">DUT_IP=&#x27;10.32.124.119&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> SNAT 规则：更改发往 dut 报文的源地址</span></span><br><span class="line">sudo iptables -t nat -A POSTROUTING -s 10.250.0.0/24 -o eth0 -j SNAT --to-source $TESTBED_SERVER_IP</span><br><span class="line"><span class="meta">#</span><span class="bash"> DNAT 规则：更改来自 dut 报文的目的地址 为 ptf container ip（10.250.0.100）</span></span><br><span class="line">sudo iptables -t nat -A PREROUTING -s $DUT_IP -j DNAT --to-destination 10.250.0.100</span><br></pre></td></tr></table></figure>
</li>
<li><p>IPv6</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> SNAT 规则：更改 BMC 发往 ntp 服务器的报文的源地址</span></span><br><span class="line">sudo ip6tables -t nat -A POSTROUTING -s fe80::ff:fe00:1 -o eth0 -j SNAT --to-source fc00:2::fc41</span><br><span class="line"><span class="meta">#</span><span class="bash"> check</span></span><br><span class="line">sudo ip6tables -t nat -v -L POSTROUTING -n --line-number</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ~~DNAT 规则：更改 ntp 服务器发往 BMC 报文的目的地址~~</span></span><br><span class="line">sudo ip6tables -t nat -A PREROUTING -s fdbd:dc00::10:8:8:12 -j DNAT --to-destination fe80::ff:fe00:1</span><br><span class="line"><span class="meta">#</span><span class="bash"> check</span></span><br><span class="line">sudo ip6tables -t nat -v -L PREROUTING -n --line-number</span><br></pre></td></tr></table></figure></li>
</ul>
<p>备注：删除规则</p>
<ul>
<li>IPv4<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 删除 SNAT 规则（查看规则编号，删除指定编号规则）</span></span><br><span class="line">sudo iptables -t nat -v -L POSTROUTING -n --line-number</span><br><span class="line">sudo iptables -t nat -D POSTROUTING &lt;num&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除 DNAT 规则（查看规则编号，删除指定编号规则）</span></span><br><span class="line">sudo iptables -t nat -v -L PREROUTING -n --line-number</span><br><span class="line">sudo iptables -t nat -D PREROUTING &lt;num&gt;</span><br></pre></td></tr></table></figure></li>
<li>IPv6<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 删除 SNAT 规则（查看规则编号，删除指定编号规则）</span></span><br><span class="line">sudo ip6tables -t nat -v -L POSTROUTING -n --line-number</span><br><span class="line">sudo ip6tables -t nat -D POSTROUTING &lt;num&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除 DNAT 规则（查看规则编号，删除指定编号规则）</span></span><br><span class="line">sudo ip6tables -t nat -v -L PREROUTING -n --line-number</span><br><span class="line">sudo ip6tables -t nat -D PREROUTING &lt;num&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="1-12-5-防火墙丢弃指定目的-mac-的包"><a href="#1-12-5-防火墙丢弃指定目的-mac-的包" class="headerlink" title="1.12.5. 防火墙丢弃指定目的 mac 的包"></a>1.12.5. 防火墙丢弃指定目的 mac 的包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 增加防火墙配置，丢弃发往目的 mac 的包（接收端执行，创造断链）</span></span><br><span class="line">sudo iptables -t filter -I OUTPUT -d 10.167.204.111 -j DROP</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 撤销上一规则（撤销所有：iptables -F）</span></span><br><span class="line">sudo iptables -t filter -D OUTPUT -d 10.167.204.111 -j DROP</span><br></pre></td></tr></table></figure>

<h3 id="1-12-6-防火墙添加-TCP、UDP-514-端口"><a href="#1-12-6-防火墙添加-TCP、UDP-514-端口" class="headerlink" title="1.12.6. 防火墙添加 TCP、UDP 514 端口"></a>1.12.6. 防火墙添加 TCP、UDP 514 端口</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 防火墙添加 TCP 514 端口</span></span><br><span class="line">sudo iptables -A INPUT -p tcp --dport 514 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> del</span></span><br><span class="line">sudo iptables -D INPUT -p tcp --dport 514 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 防火墙添加 UDP 514 端口</span></span><br><span class="line">sudo iptables -A INPUT -p udp --dport 514 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> del</span></span><br><span class="line">sudo iptables -D INPUT -p udp --dport 514 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 保存（重启后失效）</span></span><br><span class="line">sudo iptables-save</span><br></pre></td></tr></table></figure>

<h3 id="1-12-7-添加-支持接收-VxLAN-udp-报文规则"><a href="#1-12-7-添加-支持接收-VxLAN-udp-报文规则" class="headerlink" title="1.12.7. 添加 支持接收 VxLAN udp 报文规则"></a>1.12.7. 添加 支持接收 VxLAN udp 报文规则</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 重加</span></span><br><span class="line">sudo iptables -D OUTPUT -p all --source 0.0.0.0/0 --destination 0.0.0.0/0 -j ELKEID_OUTPUT</span><br><span class="line">sudo iptables -A OUTPUT -p all --source 0.0.0.0/0 --destination 0.0.0.0/0 -j ELKEID_OUTPUT</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 发送方</span></span><br><span class="line">sudo iptables -A OUTPUT -p all --source 10.11.115.104 --destination 10.11.119.78 -j ACCEPT</span><br><span class="line">sudo iptables -L -n --line-number | grep -A 10 &#x27;Chain OUTPUT&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 接收方</span></span><br><span class="line">sudo iptables -A INPUT -p all --source 10.11.115.104 --destination 10.11.119.78 -j ACCEPT</span><br><span class="line">sudo iptables -A INPUT -p all --source 10.11.113.140 --destination 10.11.119.78 -j ACCEPT</span><br><span class="line">sudo iptables -A INPUT -p all --source 10.11.113.28 --destination 10.11.114.34 -j ACCEPT</span><br><span class="line">sudo iptables -L -n --line-number | grep -A 30  &#x27;Chain INPUT&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="1-12-8-防火墙-CentOs-开启端口"><a href="#1-12-8-防火墙-CentOs-开启端口" class="headerlink" title="1.12.8. 防火墙 CentOs 开启端口"></a>1.12.8. 防火墙 CentOs 开启端口</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看防火墙状态</span></span><br><span class="line">sudo systemctl status firewalld</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看指定端口状态</span></span><br><span class="line">sudo firewall-cmd --zone=public --query-port=30001/tcp</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看所有已开放端口</span></span><br><span class="line">sudo firewall-cmd --list-all</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看已开放端口</span></span><br><span class="line">netstat -tlpn</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开放指定端口（永久生效）</span></span><br><span class="line">sudo firewall-cmd --zone=public --add-port=30001/tcp --permanent</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭指定端口（永久生效）</span></span><br><span class="line">sudo firewall-cmd --zone=public --remove-port=30001/tcp --permanent</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重载防火墙以生效</span></span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h3 id="1-12-9-备份防火墙配置到文件"><a href="#1-12-9-备份防火墙配置到文件" class="headerlink" title="1.12.9. 备份防火墙配置到文件"></a>1.12.9. 备份防火墙配置到文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables-save &gt; backup_file</span><br></pre></td></tr></table></figure>

<h2 id="1-13-证书"><a href="#1-13-证书" class="headerlink" title="1.13. 证书"></a>1.13. 证书</h2><h3 id="1-13-1-生成证书"><a href="#1-13-1-生成证书" class="headerlink" title="1.13.1. 生成证书"></a>1.13.1. 生成证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 生成证书授权CA的证书和 key</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Generate a private key for the CA</span></span></span><br><span class="line">openssl genrsa 2048 &gt; ca-key.pem</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Generate the X509 certificate for the CA</span></span></span><br><span class="line">openssl req -new -x509 -nodes -days 365000 -key ca-key.pem -out ca-cert.pem</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 填值 Country Name (2 letter code) [AU]:CN</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 填值 State or Province Name (full name) [Some-State]:.</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 生成服务端证书和 key</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Generate the private key and certificate request</span></span></span><br><span class="line">openssl req -newkey rsa:2048 -nodes -days 365000 -keyout server-key.pem -out server-req.pem</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 填值 Country Name (2 letter code) [AU]:CN</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 填值 State or Province Name (full name) [Some-State]:.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Generate the X509 certificate for the server</span></span></span><br><span class="line">openssl x509 -req -days 365000 -set_serial 01 -in server-req.pem -out server-cert.pem -CA ca-cert.pem -CAkey ca-key.pem</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 生成客户端证书和 key</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Generate the private key and certificate request</span></span></span><br><span class="line">openssl req -newkey rsa:2048 -nodes -days 365000 -keyout client-key.pem -out client-req.pem</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 填值 Country Name (2 letter code) [AU]:CN</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 填值 State or Province Name (full name) [Some-State]:.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Generate the X509 certificate for the client</span></span></span><br><span class="line">openssl x509 -req -days 365000 -set_serial 01 -in client-req.pem -out client-cert.pem -CA ca-cert.pem -CAkey ca-key.pem</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 校验证书文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Verify the server certificate</span></span></span><br><span class="line">openssl verify -CAfile ca-cert.pem ca-cert.pem server-cert.pem</span><br><span class="line">openssl verify -CAfile ca-cert.pem commonserver-cert.pem commonserver-key.pem</span><br><span class="line">openssl verify -CAfile /etc/routesyncd/routesyncd_test/certskeys/ca-cert.pem /etc/routesyncd/routesyncd_test/certskeys/server-cert.pem /etc/routesyncd/routesyncd_test/certskeys/server-key.pem</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Verify the client certificate</span></span></span><br><span class="line">openssl verify -CAfile ca-cert.pem ca-cert.pem client-cert.pem</span><br><span class="line">openssl verify -CAfile ca-cert.pem client-cert.pem client-key.pem</span><br><span class="line">openssl verify -CAfile /etc/routesyncd/routesyncd_test/certskeys/ca-cert.pem /etc/routesyncd/routesyncd_test/certskeys/client-cert.pem /etc/routesyncd/routesyncd_test/certskeys/client-key.pem</span><br></pre></td></tr></table></figure>

<h3 id="1-13-2-查看证书信息"><a href="#1-13-2-查看证书信息" class="headerlink" title="1.13.2. 查看证书信息"></a>1.13.2. 查看证书信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看 证书文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> openssl x509 -text -noout -<span class="keyword">in</span> /path/to/yourcertificate.pem</span></span><br><span class="line">openssl x509 -text -noout -in /etc/routesyncd/routesyncd_test/certskeys/ca-cert.pem</span><br><span class="line">openssl x509 -text -noout -in /etc/routesyncd/routesyncd_test/certskeys/server-cert.pem</span><br><span class="line">openssl x509 -text -noout -in /etc/routesyncd/routesyncd_test/certskeys/client-cert.pem</span><br><span class="line"></span><br><span class="line">openssl x509 -text -noout -in /etc/routesyncd/gobgpcert/ca-cert.pem</span><br><span class="line">openssl x509 -text -noout -in /etc/routesyncd/gobgpcert/commonserver-cert.pem</span><br><span class="line">openssl x509 -text -noout -in /etc/routesyncd/gobgpcert/client-cert.pem</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 key 证书私钥信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> openssl rsa -text -noout -<span class="keyword">in</span> /path/to/your_private_key.pem</span></span><br><span class="line"></span><br><span class="line">openssl rsa -text -noout -in /etc/routesyncd/routesyncd_test/certskeys/server-key.pem</span><br><span class="line">openssl rsa -text -noout -in /etc/routesyncd/routesyncd_test/certskeys/client-key.pem</span><br><span class="line"></span><br><span class="line">openssl rsa -text -noout -in /etc/routesyncd/gobgpcert/commonserver-key.pem</span><br><span class="line">openssl rsa -text -noout -in /etc/routesyncd/gobgpcert/client-key.pem</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 校验证书</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> openssl verify -CApath /path/to/the/CA_directory/ /path/to/your/certificate.pem</span></span><br><span class="line">openssl verify -CApath /root/my_cert/ cert.pem key.pem</span><br><span class="line">openssl verify -CAfile ca-cert.pem server-cert.pem client-cert.pem</span><br><span class="line">openssl verify -CAfile ca-cert.pem commonserver-cert.pem client-cert.pem</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成证书 1</span></span><br><span class="line">openssl req -newkey rsa:2048 -new -nodes -keyout key.pem -out csr.pem</span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成证书 2</span></span><br><span class="line">openssl req -newkey rsa:2048 -new -nodes -x509 -days 3650 -keyout key.pem -out cert.pem</span><br></pre></td></tr></table></figure>

<h3 id="1-13-3-查看环境支持-openssl-证书"><a href="#1-13-3-查看环境支持-openssl-证书" class="headerlink" title="1.13.3. 查看环境支持 openssl 证书"></a>1.13.3. 查看环境支持 openssl 证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">openssl ciphers -v &#x27;ALL:COMPLEMENTOFALL&#x27;</span><br><span class="line">openssl ciphers -v &#x27;ALL:COMPLEMENTOFALL&#x27; | grep TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</span><br><span class="line">TLSv1.2 Record Layer: Alert (Level: Fatal, Description: Bad Certificate)</span><br><span class="line">    Content Type: Alert (21)</span><br><span class="line">    Version: TLS 1.2 (0x0303)</span><br><span class="line">    Length: 2</span><br><span class="line">    Alert Message</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="1-14-设置服务器DNS"><a href="#1-14-设置服务器DNS" class="headerlink" title="1.14. 设置服务器DNS"></a>1.14. 设置服务器DNS</h2><p>可设置主机dns为目标DNS （&#x2F;etc&#x2F;resolv.conf）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/resolv.conf</span><br><span class="line"></span><br><span class="line">domain google.com</span><br><span class="line">options rotate</span><br><span class="line">nameserver 8.8.8.8</span><br><span class="line">nameserver 8.8.4.4</span><br></pre></td></tr></table></figure>

<h2 id="1-15-添加-apt-源"><a href="#1-15-添加-apt-源" class="headerlink" title="1.15. 添加 apt 源"></a>1.15. 添加 apt 源</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 添加阿里源，以Debian10为例</span></span><br><span class="line">mv /etc/apt/sources.list /etc/apt/sources.list.bak &amp;&amp; \</span><br><span class="line">echo &quot;deb https://mirrors.aliyun.com/debian/ buster main non-free contrib&quot; &gt; /etc/apt/sources.list &amp;&amp; \</span><br><span class="line">echo &quot;deb-src https://mirrors.aliyun.com/debian/ buster main non-free contrib&quot; &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span><br><span class="line">echo &quot;deb https://mirrors.aliyun.com/debian-security buster/updates main&quot; &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span><br><span class="line">echo &quot;deb-src https://mirrors.aliyun.com/debian-security buster/updates main&quot; &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span><br><span class="line">echo &quot;deb https://mirrors.aliyun.com/debian/ buster-updates main non-free contrib&quot; &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span><br><span class="line">echo &quot;deb-src https://mirrors.aliyun.com/debian/ buster-updates main non-free contrib&quot; &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span><br><span class="line">echo &quot;deb https://mirrors.aliyun.com/debian/ buster-backports main non-free contrib&quot; &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span><br><span class="line">echo &quot;deb-src https://mirrors.aliyun.com/debian/ buster-backports main non-free contrib&quot; &gt;&gt; /etc/apt/sources.list</span><br></pre></td></tr></table></figure>

<h2 id="1-16-更新-apt-source-list"><a href="#1-16-更新-apt-source-list" class="headerlink" title="1.16. 更新 apt-source-list"></a>1.16. 更新 apt-source-list</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 编辑</span></span><br><span class="line">/etc/apt/source.list</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 或在下方目录添加 <span class="built_in">source</span> list 文件</span></span><br><span class="line">/etc/apt/sources.list.d/*</span><br><span class="line"></span><br><span class="line">apt-get update -y</span><br></pre></td></tr></table></figure>

<h2 id="1-17-添加静态DNS解析和静态路由"><a href="#1-17-添加静态DNS解析和静态路由" class="headerlink" title="1.17. 添加静态DNS解析和静态路由"></a>1.17. 添加静态DNS解析和静态路由</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> （临时）加了两条 hosts 和路由</span></span><br><span class="line">echo &#x27;10.20.30.40 ABC.org&#x27; &gt;&gt; /etc/hosts</span><br><span class="line">sudo /etc/init.d/networking restart</span><br><span class="line">sudo ip route add 10.20.30.40 via 10.0.0.1 dev eth0</span><br><span class="line"></span><br><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>

<h2 id="1-18-安装-Apache2-网页"><a href="#1-18-安装-Apache2-网页" class="headerlink" title="1.18. 安装 Apache2 网页"></a>1.18. 安装 Apache2 网页</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">apt install apache2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建站点文件夹</span></span><br><span class="line">SITE_DIR=&#x27;/data00/www&#x27;</span><br><span class="line">mkdir -p $SITE_DIR</span><br><span class="line">sudo chown -R root:root $SITE_DIR/html</span><br><span class="line">sudo chmod -R $SITE_DIR/html 400</span><br><span class="line">sudo find $SITE_DIR/html -type d -exec chmod 755 &#123;&#125; \;</span><br><span class="line">sudo find $SITE_DIR/html -type f -exec chmod 644 &#123;&#125; \;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> （可选）配置站点目录（DocumentRoot /var/www/html -&gt;  /data00/www/html ）</span></span><br><span class="line">vi /etc/apache2/sites-available/000-default.conf</span><br><span class="line">DocumentRoot /var/www/html</span><br><span class="line"><span class="meta">#</span><span class="bash"> DocumentRoot /data00/www/html</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> (可选) 配置站点指定 URL 路径对应 站点路径（可不在 DocumentROOT 下）</span></span><br><span class="line">vi /etc/apache2/sites-available/000-default.conf</span><br><span class="line"><span class="meta">	#</span><span class="bash"> Alias <span class="string">&quot;/sonic&quot;</span> <span class="string">&quot;/data00/fileserver/files/sonic&quot;</span></span></span><br><span class="line"><span class="meta">	#</span><span class="bash"> &lt;Directory <span class="string">&quot;/data00/fileserver/files/sonic&quot;</span>&gt;</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">     Options Indexes MultiViews</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">     AllowOverride None</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">     Require all granted</span></span><br><span class="line"><span class="meta">	#</span><span class="bash"> &lt;/Directory&gt;</span></span><br><span class="line"><span class="meta">	#</span><span class="bash"> Alias <span class="string">&quot;/bfn&quot;</span> <span class="string">&quot;/data00/fileserver/files/bfn&quot;</span></span></span><br><span class="line"><span class="meta">	#</span><span class="bash"> &lt;Directory <span class="string">&quot;/data00/fileserver/files/bfn&quot;</span>&gt;</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">     Options Indexes MultiViews</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">     AllowOverride None</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">     Require all granted</span></span><br><span class="line"><span class="meta">	#</span><span class="bash"> &lt;/Directory&gt;</span></span><br><span class="line"><span class="meta">	#</span><span class="bash"> Alias <span class="string">&quot;/sonic_dep_pkgs&quot;</span> <span class="string">&quot;/data00/fileserver/files/sonic_dep_pkgs&quot;</span></span></span><br><span class="line"><span class="meta">	#</span><span class="bash"> &lt;Directory <span class="string">&quot;/data00/fileserver/files/sonic_dep_pkgs&quot;</span>&gt;</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">     Options Indexes MultiViews</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">     AllowOverride None</span></span><br><span class="line"><span class="meta">	#</span><span class="bash">     Require all granted</span></span><br><span class="line"><span class="meta">	#</span><span class="bash"> &lt;/Directory&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置文件 （修改默认站点 /var/www/ 为 /data00/www/ ）</span></span><br><span class="line">vi /etc/apache2/apache2.conf</span><br><span class="line"></span><br><span class="line">sudo systemctl restart apache2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> check</span></span><br><span class="line">sudo systemctl status apache2</span><br></pre></td></tr></table></figure>

<h2 id="1-19-解决-SSH-自动断连问题"><a href="#1-19-解决-SSH-自动断连问题" class="headerlink" title="1.19. 解决 SSH 自动断连问题"></a>1.19. 解决 SSH 自动断连问题</h2><p>step 1. 修改 &#x2F;etc&#x2F;profile中改MOUT的值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 检查（未设置/缺省值为 0，表示不超时）</span></span><br><span class="line">echo $TMOUT</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 若超过 0，则可在 /etc/profile 之类文件中设置它为 0</span></span><br><span class="line">sudo vi /etc/profile</span><br></pre></td></tr></table></figure>

<p>step 2. 修改 &#x2F;etc&#x2F;ssh&#x2F;sshd_config 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 注释掉下面的 (允许账户密码登录)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">PasswordAuthentication no</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 将允许添加了 authorized_keys 的客户端免密登录设置为 yes</span></span><br><span class="line">PubkeyAuthentication yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> (opt). 设置 ClientAliveInterval，表示服务器端向客户端请求消息的时间间隔（默认值 0，不发送），应改为 60 每分钟发送一次，从而保持长连接</span></span><br><span class="line">ClientAliveInterval 60</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> (opt). 设置 ClientAliveCountMax，表示允许探活失败并断链的最大次数，改为 3 即可</span></span><br><span class="line">ClientAliveCountMax 3</span><br></pre></td></tr></table></figure>

<p>step3. 重启 sshd 服务，以生效配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl reload sshd</span><br><span class="line"><span class="meta">#</span><span class="bash"> sudo /etc/init.d/ssh restart</span></span><br></pre></td></tr></table></figure>

<h2 id="1-20-删除已知-HOST"><a href="#1-20-删除已知-HOST" class="headerlink" title="1.20. 删除已知 HOST"></a>1.20. 删除已知 HOST</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -f ~/.ssh/known_hosts -R &#x27;192.168.3.58&#x27;</span><br></pre></td></tr></table></figure>

<h1 id="2-排障"><a href="#2-排障" class="headerlink" title="2. 排障"></a>2. 排障</h1><h2 id="2-1-查看网口信息（speed）"><a href="#2-1-查看网口信息（speed）" class="headerlink" title="2.1. 查看网口信息（speed）"></a>2.1. 查看网口信息（speed）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo ethtool eth1</span><br><span class="line">sudo ethtool eth0 | grep -i speed</span><br><span class="line">sudo ethtool eth1 | grep -i speed</span><br></pre></td></tr></table></figure>

<h2 id="2-2-查看网卡型号"><a href="#2-2-查看网卡型号" class="headerlink" title="2.2. 查看网卡型号"></a>2.2. 查看网卡型号</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">lspci | egrep -i --color &#x27;network|ethernet&#x27;</span><br><span class="line">lspci | egrep -i --color &#x27;network|ethernet|wireless|wi-fi&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 eth0/1 各接口 网卡型号</span></span><br><span class="line">sudo lshw -class network -short | fgrep -v &#x27;Ethernet interface&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看具体 接口硬件信息</span></span><br><span class="line">sudo ethtool -i eth0</span><br></pre></td></tr></table></figure>

<h2 id="2-3-查看端口占用"><a href="#2-3-查看端口占用" class="headerlink" title="2.3. 查看端口占用"></a>2.3. 查看端口占用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> (UDP类型的端口)</span></span><br><span class="line">netstat -nupl</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> (TCP类型的端口)</span></span><br><span class="line">netstat -ntpl</span><br></pre></td></tr></table></figure>

<h2 id="2-4-查看指定端口的建链数"><a href="#2-4-查看指定端口的建链数" class="headerlink" title="2.4. 查看指定端口的建链数"></a>2.4. 查看指定端口的建链数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo netstat -nat | grep :8089</span><br></pre></td></tr></table></figure>

<h2 id="2-5-查看-ssh-登录在线人数"><a href="#2-5-查看-ssh-登录在线人数" class="headerlink" title="2.5. 查看 ssh 登录在线人数"></a>2.5. 查看 ssh 登录在线人数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 统计 ssh 在线人数</span></span><br><span class="line">w | grep pts | wc -l</span><br></pre></td></tr></table></figure>

<h2 id="2-6-手动获取-DHCP-ip"><a href="#2-6-手动获取-DHCP-ip" class="headerlink" title="2.6. 手动获取 DHCP ip"></a>2.6. 手动获取 DHCP ip</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dhclient -v eth0</span><br></pre></td></tr></table></figure>

<h2 id="2-7-查看网络服务状态"><a href="#2-7-查看网络服务状态" class="headerlink" title="2.7. 查看网络服务状态"></a>2.7. 查看网络服务状态</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status networking</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启网络</span></span><br><span class="line">sudo systemctl restart networking</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启特定网卡</span></span><br><span class="line">ifdown eth2; ifup eth2</span><br><span class="line">ifdown eth3; ifup eth3</span><br></pre></td></tr></table></figure>

<h2 id="2-8-查看网卡数据"><a href="#2-8-查看网卡数据" class="headerlink" title="2.8. 查看网卡数据"></a>2.8. 查看网卡数据</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">MY_ETH=&#x27;eth4&#x27;</span><br><span class="line">MY_ETH=&#x27;eth5&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看系统硬件信息及网卡驱动</span></span><br><span class="line">sudo lshw -C network | grep -C 7 $MY_ETH</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看网口基本信息</span></span><br><span class="line">ethtool $MY_ETH</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 点亮网卡灯（亮 10 秒）</span></span><br><span class="line">ethtool -p $MY_ETH 10</span><br><span class="line">ethtool -p eth1 100</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看网卡队列数量（多队列提升性能）</span></span><br><span class="line">ethtool -l $MY_ETH</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 修改网卡队列数</span></span></span><br><span class="line">ethtool -L $MY_ETH combined 4</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查询网口驱动相关信息</span></span><br><span class="line">ethtool -i $MY_ETH</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示网卡 「环形队列」RingBuffer 大小 （最大值，当前实际分配至）</span></span><br><span class="line">ethtool -g $MY_ETH</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改「环形队列」RingBuffer 大小</span></span><br><span class="line">ethtool -G $MY_ETH rx 4096 tx 4096</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看网口所有统计相关信息</span></span><br><span class="line">ethtool -S $MY_ETH</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 查看网卡各个队列收包数据</span></span></span><br><span class="line">ethtool -S $MY_ETH | grep rx_queue | grep packets</span><br><span class="line">ethtool -S $MY_ETH | grep packets</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 查看网卡因 「环形队列」RingBuffer满丢包数</span></span></span><br><span class="line">ethtool -S $MY_ETH | fifo_errors</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示网卡 offload 参数的状态</span></span><br><span class="line">ethtool -k $MY_ETH</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看网卡 ntuple 配置规则</span></span><br><span class="line">ethtool -n $MY_ETH</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看现有 flow-hash 配置</span></span><br><span class="line">ethtool -n $MY_ETH rx-flow-hash tcp4</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 同时设置 速率/全双工/关自协商</span></span><br><span class="line">sudo ethtool -s $MY_ETH speed 100000 duplex full autoneg off</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置网口速率 Mbps (10/100/1000/10000/100000)，自协商需关闭</span></span><br><span class="line">ethtool -s $MY_ETH speed 100000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置网口半/全双工 (half|full)，自协商需关闭</span></span><br><span class="line">ethtool -s $MY_ETH duplex full</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置网口是否自协商 (on|off)</span></span><br><span class="line">ethtool -s $MY_ETH autoneg on</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置网口类型 (tp|aui|bnc|mii)</span></span><br><span class="line">ethtool -s $MY_ETH port tp|aui|bnc|mii</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看队列对应硬件中断号</span></span><br><span class="line">cat /proc/interrupts</span><br></pre></td></tr></table></figure>

<h2 id="2-9-查看网卡-MAC-地址"><a href="#2-9-查看网卡-MAC-地址" class="headerlink" title="2.9. 查看网卡 MAC 地址"></a>2.9. 查看网卡 MAC 地址</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/sbin/ifconfig eth0 | grep &#x27;ether&#x27;  | awk &#x27;&#123; print $2 &#125;&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或</span></span><br><span class="line">cat /sys/class/net/eth0/address</span><br></pre></td></tr></table></figure>

<h2 id="2-10-网卡不能正常-UP-定位"><a href="#2-10-网卡不能正常-UP-定位" class="headerlink" title="2.10. 网卡不能正常 UP 定位"></a>2.10. 网卡不能正常 UP 定位</h2><p>定位 eth4 不能 up</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 罗列 pci 查看网卡型号 (e.g. 得知网卡为脉络思 Mellanox 网卡)</span></span><br><span class="line">sudo lspci -v | grep -A 10 &#x27;Ethernet controller&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看网卡驱动名 （e.g. mlx5_core ）</span></span><br><span class="line">sudo lspci -v | grep -A 10 &#x27;Ethernet controller&#x27; | grep driver | cut -d : -f 2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看系统异常告警信息 (得知 eth4 PCIE 地址 0000:86:00.0 )</span></span><br><span class="line">sudo dmesg | grep -E &#x27;mlx5_core|eth4&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 eth4</span></span><br><span class="line">sudo udevadm test-builtin net_id /sys/class/net/eth4</span><br><span class="line"></span><br><span class="line">sudo udevadm info /sys/class/net/eth4</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开 eth4 电源</span></span><br><span class="line">ETH_PCIE_ADDR=&#x27;0000:86:00.0&#x27;</span><br><span class="line">sudo bash -c &quot;echo on &gt; /sys/bus/pci/devices/$ETH_PCIE_ADDR/power/control&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 还不行，考虑是否光模块没接好</span></span><br><span class="line">sudo ethtool eth4 | grep &#x27;Link detected&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="2-11-抓包"><a href="#2-11-抓包" class="headerlink" title="2.11. 抓包"></a>2.11. 抓包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth0 | grep &quot;192.168.3.238&quot;</span><br><span class="line">sudo tcpdump -i eth0 -vv -xx -w mgmt.pcap</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 抓包指定端口（采集器端执行）</span></span><br><span class="line">sudo tcpdump -i Bridge port 8088 -n</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 抓取指定目的 IP 的包</span></span><br><span class="line">sudo tcpdump -i Bridge dst net 10.167.204.111</span><br><span class="line">sudo tcpdump -i Bridge -vnn dst net 10.32.124.119</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 抓取目的 IP 为 10.167.204.111 且源 port 为 8088 的包</span></span><br><span class="line">sudo tcpdump -i Bridge -vnn dst host 10.167.204.111 and src port 8088</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1、抓取包含 10.10.10.122 的数据包</span></span><br><span class="line">sudo tcpdump -i eth0 -vnn host 10.10.10.122</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2、抓取包含 10.10.10.0/24 网段的数据包</span></span><br><span class="line">sudo tcpdump -i eth0 -vnn net 10.10.10.0/24</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3、抓取包含端口 22 的数据包</span></span><br><span class="line">sudo tcpdump -i eth0 -vnn port 22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4、抓取 udp 协议的数据包</span></span><br><span class="line">sudo tcpdump -i any -nn -vv proto UDP</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4、抓取 udp 协议 且 源目 IP 包含指定 IP 的数据包</span></span><br><span class="line">sudo tcpdump -i any -nn -vv proto UDP and host 10.134.22.222</span><br><span class="line"><span class="meta">#</span><span class="bash"> 5、抓取 icmp 协议的数据包</span></span><br><span class="line">sudo tcpdump -i eth0 -vnn icmp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 6、抓取 arp 协议的数据包</span></span><br><span class="line">sudo tcpdump -i eth0 -vnn arp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 7、抓取 ip 协议的数据包</span></span><br><span class="line">sudo tcpdump -i eth0 -vnn ip</span><br><span class="line"><span class="meta">#</span><span class="bash"> 8、抓取源 ip 是 10.10.10.122 数据包。</span></span><br><span class="line">sudo tcpdump -i eth0 -vnn src host 10.10.10.122</span><br><span class="line"><span class="meta">#</span><span class="bash"> 9、抓取目的 ip 是 10.10.10.122 数据包</span></span><br><span class="line">sudo tcpdump -i eth0 -vnn dst host 10.10.10.122</span><br><span class="line">sudo tcpdump -i eth0 -vnn dst host 10.32.124.119</span><br><span class="line"><span class="meta">#</span><span class="bash"> 10、抓取源端口是 22 的数据包</span></span><br><span class="line">sudo tcpdump -i eth0 -vnn src port 22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 11、抓取源 ip 是 10.10.10.253 且目的 ip 是 22 的数据包</span></span><br><span class="line">sudo tcpdump -i eth0 -vnn src host 10.10.10.253 and dst port 22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 12、抓取源 ip 是 10.10.10.122 或者包含端口是 22 的数据包</span></span><br><span class="line">sudo tcpdump -i eth0 -vnn src host 10.10.10.122 or port 22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 13、抓取源 ip 是 10.10.10.122 且端口不是 22 的数据包</span></span><br><span class="line">sudo tcpdump -i eth0 -vnn src host 10.10.10.122 and not port 22</span><br><span class="line"><span class="meta">#</span><span class="bash"> 14、抓取源 ip 是 10.10.10.2 且目的端口是 22，或源 ip 是 10.10.10.65 且目的端口是 80 的数据包。</span></span><br><span class="line">sudo tcpdump -i eth0 -vnn ( src host 10.10.10.2 and dst port 22 ) or ( src host 10.10.10.65 and dst port 80 )</span><br><span class="line"><span class="meta">#</span><span class="bash"> 15、抓取源 ip 是 10.10.10.59 且目的端口是 22，或源 ip 是 10.10.10.68 且目的端口是 80 的数据包。</span></span><br><span class="line">sudo tcpdump -i eth0 -vnn ‘src host 10.10.10.59 and dst port 22’ or ’ src host 10.10.10.68 and dst port 80 ’</span><br><span class="line"><span class="meta">#</span><span class="bash"> 16、把抓取的数据包记录存到/tmp/fill 文件中，当抓取 100 个数据包后就退出程序。</span></span><br><span class="line">sudo tcpdump –i eth0 -vnn -w /tmp/fil1 -c 100</span><br><span class="line"><span class="meta">#</span><span class="bash"> 17、从/tmp/fill 记录中读取 tcp 协议的数据包</span></span><br><span class="line">sudo tcpdump –i eth0 -vnn -r /tmp/fil1 tcp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 18、从/tmp/fill 记录中读取包含 10.10.10.58 的数据包</span></span><br><span class="line">sudo tcpdump –i eth0 -vnn -r /tmp/fil1 host 10.10.10.58</span><br></pre></td></tr></table></figure>

<h2 id="2-12-TFTP传输"><a href="#2-12-TFTP传输" class="headerlink" title="2.12. TFTP传输"></a>2.12. TFTP传输</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 从 netadmin 服务器 /tftpboot/ 下拉文件（注：需提前拷到 /tftpboot/， 且目标文件不能为文件夹）</span></span><br><span class="line">tftp 10.20.30.40 -c get extract_error_log.sh /home/haoleeson/extract_error_log.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 上传文件到 netadmin 服务器的 /tftpboot/ 目录 （注：发送文件指定当前文件夹中的文件即可）</span></span><br><span class="line">tftp 10.20.30.40 -c put /home/haoleeson/test12390.txt</span><br></pre></td></tr></table></figure>

<h2 id="2-13-SFTP传输"><a href="#2-13-SFTP传输" class="headerlink" title="2.13. SFTP传输"></a>2.13. SFTP传输</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 上传文件到指定远程服务器目录（类似 scp，需输入密码）</span></span><br><span class="line">sftp haoleeson@10.20.30.40:/home/haoleeson/inspect_error_log &lt;&lt;&lt; $&#x27;put /home/haoleeson/test12390.txt&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载文件到本地</span></span><br><span class="line">sftp haoleeson@10.20.30.40:/home/haoleeson/pexpect-2.3.tar.gz ./</span><br></pre></td></tr></table></figure>

<h2 id="2-14-SCP传输"><a href="#2-14-SCP传输" class="headerlink" title="2.14. SCP传输"></a>2.14. SCP传输</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 通过跳板机上传文档至生产设备</span></span><br><span class="line">scp -o ProxyCommand=&quot;ssh -qW %h:%p jump-proxy.org&quot; -r &lt;src-dir&gt; root@10.20.30.40:/root/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 下载服务器日志（在 mac 终端执行）</span></span></span><br><span class="line">scp -J netjump haoleeson@10.20.30.40:logfile/logfile10.log ~/Downloads/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 下载 testbed 服务器文件到本地（在 mac 终端执行）</span></span></span><br><span class="line">scp -J netjump haoleeson@10.20.30.40:/data00/home/haoleeson/test.log  ~/Downloads/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> scp 拉取/发送多个文件，用引号包含多个文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 拉取指定多个文件</span></span><br><span class="line">scp haoleeson@10.20.30.40:&quot;path_to_file_a  path_to_file_b&quot; ~/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 发送多个文件到远程</span></span><br><span class="line">scp &quot;path_to_file_a  path_to_file_b&quot; haoleeson@10.20.30.40:/home/haoleeson/</span><br></pre></td></tr></table></figure>

<h2 id="2-15-curl"><a href="#2-15-curl" class="headerlink" title="2.15. curl"></a>2.15. curl</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 模拟 POST 请求</span></span><br><span class="line">curl -header &quot;Content-Type: application/json&quot;</span><br><span class="line">	-X POST</span><br><span class="line">	-d --data &#x27;&#123;&quot;args&quot;: &#125;&#x27;</span><br><span class="line">	&quot;http://192.168.0.1:8001/test&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 模拟 POST 请求</span></span><br><span class="line">curl  -d -H &quot;Content-Type: application/json&quot; --data &#x27;&#123;&quot;args&quot;: []&#125;&#x27; \</span><br><span class="line">        http://10.32.124.40:8000/platform/chassis/get_system_eeprom_info</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 模拟 POST 请求，调 HPA xgw-test-agent api 宣告路由</span></span><br><span class="line">curl -d &#x27;&#123;&quot;v4_ips&quot;:[&quot;192.168.138.10/32&quot;],&quot;v6_ips&quot;:[&quot;10:254:254::254/128&quot;]&#125;&#x27; -H &quot;Content-Type: application/json&quot; -X POST http://127.0.0.1:11001/config_bgp_network</span><br><span class="line">curl -d &#x27;&#123;&quot;v4_ips&quot;:[&quot;192.168.138.10/32&quot;],&quot;v6_ips&quot;:[]&#125;&#x27; -H &quot;Content-Type: application/json&quot; -X POST http://127.0.0.1:11001/config_bgp_network</span><br><span class="line"></span><br><span class="line">curl -d &#x27;&#123;&#125;&#x27; -H &quot;Content-Type: application/json&quot; -X POST http://10.11.112.137:11001/is_lambda</span><br><span class="line">curl -d &#x27;&#123;&quot;name&quot;:&quot;xgw_controller&quot;&#125;&#x27; -H &quot;Content-Type: application/json&quot; -X POST http://10.11.112.137:11001/restart_docker</span><br></pre></td></tr></table></figure>

<h2 id="2-16-查看-Linux-TCP-keepalive-配置"><a href="#2-16-查看-Linux-TCP-keepalive-配置" class="headerlink" title="2.16. 查看 Linux TCP keepalive 配置"></a>2.16. 查看 Linux TCP keepalive 配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -a | grep keepalive</span><br></pre></td></tr></table></figure>

<h1 id="3-测试"><a href="#3-测试" class="headerlink" title="3. 测试"></a>3. 测试</h1><h2 id="3-1-网络测速工具-iperf"><a href="#3-1-网络测速工具-iperf" class="headerlink" title="3.1. 网络测速工具 iperf"></a>3.1. 网络测速工具 iperf</h2><h3 id="3-1-1-开启防火墙-5001-端口-iperf2-默认-5001-iperf3-默认-5201"><a href="#3-1-1-开启防火墙-5001-端口-iperf2-默认-5001-iperf3-默认-5201" class="headerlink" title="3.1.1. 开启防火墙 5001 端口(iperf2 默认 5001, iperf3 默认 5201)"></a>3.1.1. 开启防火墙 5001 端口(iperf2 默认 5001, iperf3 默认 5201)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 5001 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p udp --dport 5001 -j ACCEPT</span><br><span class="line"><span class="meta">#</span><span class="bash"> check</span></span><br><span class="line">iptables -n -L | grep 5001</span><br></pre></td></tr></table></figure>
<h3 id="3-1-2-TCP-测试"><a href="#3-1-2-TCP-测试" class="headerlink" title="3.1.2. TCP 测试"></a>3.1.2. TCP 测试</h3><p><strong>-B 10.0.0.45</strong>: 绑定自身 IP<br><strong>-s</strong>: 服务端端</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 一台运行服务端 (10.0.0.45)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> iperf -B &lt;my_interface_ip&gt; -s</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># -p 服务端 端口号</span></span></span><br><span class="line">iperf -B 10.0.0.45 -p 5001 -s</span><br><span class="line">iperf -B 10.201.40.80 -p 5001 -s</span><br><span class="line">iperf -B 172.16.1.1 -p 5001 -s</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 一台运行服务端 (10.0.0.47)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> iperf -B &lt;my_interface_ip&gt; -c &lt;server_ip&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># -p 服务端 端口号</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># -t 测试秒数</span></span></span><br><span class="line">iperf -B 10.0.0.47 -c 10.0.0.45</span><br><span class="line">iperf -B 10.32.124.41 -c 10.201.40.80</span><br><span class="line">iperf -B 192.168.1.1 -c 172.16.1.1</span><br></pre></td></tr></table></figure>

<h3 id="3-1-3-UDP测试"><a href="#3-1-3-UDP测试" class="headerlink" title="3.1.3. UDP测试"></a>3.1.3. UDP测试</h3><p><strong>-b 100M</strong> : 带宽限制 100Mbps</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 服务器执行</span></span><br><span class="line">iperf -B 20.0.0.51 -p 5001 -u -s</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端执行 （打流带宽限制 300K bps）</span></span><br><span class="line">iperf -B 20.0.0.52 -c 20.0.0.51 -u -b 300K -t 60</span><br><span class="line"><span class="meta">#</span><span class="bash"> iperf -u -c 10.0.0.45 -b 900M  -i 1  -w 1M  -t 60</span></span><br></pre></td></tr></table></figure>

<h2 id="3-2-安装qume虚拟机"><a href="#3-2-安装qume虚拟机" class="headerlink" title="3.2. 安装qume虚拟机"></a>3.2. 安装qume虚拟机</h2><blockquote>
<p>镜像资源：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://cdimage.debian.org/cdimage/archive/9.13.0/amd64/iso-cd/debian-9.13.0-amd64-netinst.iso">Debian 9.13 (stretch)</a></li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">apt-get install qemu-kvm qemu-utils virt-manager libvirt-daemon gir1.2-spiceclientgtk-3.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">sudo apt install qemu-kvm libvirt-clients libvirt-daemon-system bridge-utils virtinst libvirt-daemon virt-manager -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查</span></span><br><span class="line">sudo systemctl status libvirtd.service</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看可供 kvm 使用的网络</span></span><br><span class="line">sudo virsh net-list --all</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置 kvm 网络</span></span><br><span class="line">sudo virsh net-start default</span><br><span class="line">sudo virsh net-autostart default</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 新增用户组</span></span><br><span class="line">sudo newgrp libvirt</span><br><span class="line">sudo newgrp libvirt-qemu</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置普通用户也可使用 virsh</span></span><br><span class="line">sudo adduser pkumar libvirt</span><br><span class="line">sudo adduser pkumar libvirt-qemu</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash">sudo apt-get install qemu qemu-kvm</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建虚拟机</span></span><br><span class="line">sudo virt-install --name ubuntu-vm --os-type linux --os-variant ubuntu18.04 --ram 1024 --vcpu 1 --disk path=/var/lib/libvirt/images/ubuntu-vm.qcow2,size=10 --graphics vnc,listen=0.0.0.0 --noautoconsole --hvm --cdrom /home/pkumar/ubuntu-18.04-live-server-amd64.iso --boot cdrom,hd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看运行中 虚拟机</span></span><br><span class="line">sudo virsh list --all</span><br></pre></td></tr></table></figure>

<h2 id="3-3-解析设备-IP"><a href="#3-3-解析设备-IP" class="headerlink" title="3.3. 解析设备 IP"></a>3.3. 解析设备 IP</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 通过读配置文件获取 IP（可能与实际不一致）</span></span><br><span class="line">grep -A 1 &#x27;MGMT_INTERFACE&#x27; /etc/sonic/libra_user.json | tail -n +2 | cut -d &#x27;|&#x27; -f 2 | cut -d / -f 1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过命令查当前设备 IP</span></span><br><span class="line">ip addr show eth0 | grep -oP \(\\d+\\.\)&#123;3&#125;\\d+</span><br><span class="line">ip addr show eth0 | grep -oE \([0-9]+\\.\)&#123;3&#125;[0-9]+</span><br><span class="line">ip addr show eth0 | grep -oE &#x27;([0-9]+\.)&#123;3&#125;[0-9]+&#x27;</span><br><span class="line">ip addr show eth0 | grep -oE &quot;([0-9]&#123;1,3&#125;[\.])&#123;3&#125;[0-9]&#123;1,3&#125;&quot;</span><br><span class="line">ip addr show eth0 | grep global | awk &#x27;&#123; print $2 &#125;&#x27; | cut -d / -f 1</span><br><span class="line">ip addr show eth0 | grep inet | head -1 | tr / \ | cut -d \  -f 6</span><br><span class="line">ip addr show eth0 | awk &#x27;$1 == &quot;inet&quot; &#123;gsub(/\/.*$/, &quot;&quot;, $2); print $2&#125;&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="3-4-Scapy"><a href="#3-4-Scapy" class="headerlink" title="3.4. Scapy"></a>3.4. Scapy</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 克隆</span></span><br><span class="line">git clone https://github.com/secdev/scapy</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">cd scapy</span><br><span class="line">sudo python setup.py install</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> check</span></span><br><span class="line">scapy</span><br></pre></td></tr></table></figure>

<h3 id="3-4-1-查看设备网络接口"><a href="#3-4-1-查看设备网络接口" class="headerlink" title="3.4.1. 查看设备网络接口"></a>3.4.1. 查看设备网络接口</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 运行</span></span><br><span class="line">sudo ./run_scapy -H</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看所有网络接口</span></span><br><span class="line">get_if_list()</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或</span></span><br><span class="line">conf.ifaces</span><br></pre></td></tr></table></figure>

<h3 id="3-4-2-查看路由"><a href="#3-4-2-查看路由" class="headerlink" title="3.4.2. 查看路由"></a>3.4.2. 查看路由</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看路由</span></span><br><span class="line">conf.route</span><br><span class="line">conf.route6</span><br></pre></td></tr></table></figure>

<h3 id="3-4-3-查看某接口-IP-x2F-MAC"><a href="#3-4-3-查看某接口-IP-x2F-MAC" class="headerlink" title="3.4.3. 查看某接口 IP&#x2F;MAC"></a>3.4.3. 查看某接口 IP&#x2F;MAC</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 获取接口 IP</span></span><br><span class="line">get_if_addr(&quot;eth0&quot;)</span><br><span class="line">get_if_addr(&quot;Ethernet32&quot;)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取接口 MAC</span></span><br><span class="line">get_if_hwaddr(&quot;eth0&quot;)</span><br><span class="line">get_if_hwaddr(&quot;Ethernet32&quot;)</span><br><span class="line">getmacbyip(&quot;10.0.0.1&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="3-4-4-简单-demo"><a href="#3-4-4-简单-demo" class="headerlink" title="3.4.4. 简单 demo"></a>3.4.4. 简单 demo</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 运行</span></span><br><span class="line">sudo ./run_scapy -H</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 构造报文</span></span><br><span class="line">p = IP(dst=&quot;github.com&quot;)/ICMP()</span><br><span class="line">p2 = Ether(src=&#x27;00:00:00:00:00:01&#x27;,dst=&#x27;00:00:00:00:00:02&#x27;)/IP(dst=&quot;10.32.124.40&quot;)/ICMP()</span><br><span class="line">p3 = Ether()/IP(dst=&#x27;192.168.1.2&#x27;,ttl=10)/TCP(dport=80)</span><br><span class="line">p4 = ARP(op=1, hwdst=&quot;ff:ff:ff:ff:ff:ff&quot;, pdst=ip_address)</span><br></pre></td></tr></table></figure>

<h3 id="3-4-5-构造报文（计算校验和方式-1）"><a href="#3-4-5-构造报文（计算校验和方式-1）" class="headerlink" title="3.4.5. 构造报文（计算校验和方式 1）"></a>3.4.5. 构造报文（计算校验和方式 1）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p = IP(src=&#x27;192.168.1.1&#x27;,dst=&#x27;192.168.1.2&#x27;)/TCP()/&#x27;abcdefg&#x27;</span><br><span class="line">p = IP(raw(p))</span><br></pre></td></tr></table></figure>

<h3 id="3-4-6-构造报文（计算校验和方式-2）"><a href="#3-4-6-构造报文（计算校验和方式-2）" class="headerlink" title="3.4.6. 构造报文（计算校验和方式 2）"></a>3.4.6. 构造报文（计算校验和方式 2）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p = IP(src=&#x27;192.168.1.1&#x27;,dst=&#x27;192.168.1.2&#x27;)/TCP(chksum=0)/&#x27;abcdefg&#x27;</span><br><span class="line">chk_str = raw(p)[20:]</span><br><span class="line">p[TCP].chksum = in4_chksum(socket.IPPROTO_TCP,p[IP],chk_str)</span><br></pre></td></tr></table></figure>

<h3 id="3-4-7-发包-x2F-收包"><a href="#3-4-7-发包-x2F-收包" class="headerlink" title="3.4.7. 发包&#x2F;收包"></a>3.4.7. 发包&#x2F;收包</h3><h4 id="3-4-7-1-二层发包，指定出接口"><a href="#3-4-7-1-二层发包，指定出接口" class="headerlink" title="3.4.7.1. 二层发包，指定出接口"></a>3.4.7.1. 二层发包，指定出接口</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 发二层包（指定出接口），无效</span></span><br><span class="line">sendp(&quot;I&#x27;m travelling on Ethernet&quot;, iface=&#x27;Ethernet2&#x27;, loop=1, inter=0.1)</span><br></pre></td></tr></table></figure>

<h4 id="3-4-7-2-普通收发包"><a href="#3-4-7-2-普通收发包" class="headerlink" title="3.4.7.2. 普通收发包"></a>3.4.7.2. 普通收发包</h4><p>通过 default 路由发包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 仅发</span></span><br><span class="line">send(pkt, inter=0, loop=0, count=1, iface=N)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 发包且收包</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sr(): 接收多个回包</span></span><br><span class="line">sr(IP(dst=&quot;www.baidu.com&quot;,ttl=(1,4))/TCP(dport=[21,23,80],flags=&quot;S&quot;))</span><br><span class="line"><span class="meta">#</span><span class="bash"> sr1()：仅接收第一个回包</span></span><br><span class="line">sr1(IP(dst=&quot;www.baidu.com&quot;,ttl=(1,4))/ICMP())</span><br><span class="line"><span class="meta">#</span><span class="bash"> srloop()： 循环发包/收包 （可配发包间隔、次数）</span></span><br><span class="line">srloop(IP(dst=&quot;www.baidu.com&quot;,ttl=1)/ICMP(),inter=3,count=2) #每隔3秒ping一次，一共执行两次</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-4-8-嗅探"><a href="#3-4-8-嗅探" class="headerlink" title="3.4.8. 嗅探"></a>3.4.8. 嗅探</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line">pkt = sniff(iface = <span class="string">&quot;Realtek PCIe GBE Family Controller&quot;</span>,count = <span class="number">3</span> ,<span class="built_in">filter</span>=<span class="string">&#x27;tcp&#x27;</span>,prn = <span class="keyword">lambda</span> x: x.sprintf(<span class="string">&#x27;&#123;IP:%IP.src%-&gt;%IP.dst%\n&#125;&#123;Raw:%Raw.load%\n&#125;&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># filter:过滤条件</span></span><br><span class="line"><span class="comment"># iface：网卡接口名称</span></span><br><span class="line"><span class="comment"># count：数据包数量</span></span><br><span class="line"><span class="comment"># prn:回调函数，通常与lambda搭配使用</span></span><br><span class="line"><span class="comment"># sprintf()函数控制输入信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 抓取源地址为192.168.3.3的端口为80的tcp报文：</span></span><br><span class="line">sniff(<span class="built_in">filter</span>=<span class="string">&quot;ip src 192.168.3.3 and tcp and tcp port 80&quot;</span>, prn=<span class="keyword">lambda</span> x:x.summary())</span><br><span class="line"><span class="comment"># 抓取目的地址网段为192.168.3.3/24的报文：</span></span><br><span class="line">sniff(<span class="built_in">filter</span>=<span class="string">&quot;dst net 192.168&quot;</span>, prn=<span class="keyword">lambda</span> x:x.summary())</span><br><span class="line"><span class="comment"># 抓取非ICMP的报文：</span></span><br><span class="line">sniff(<span class="built_in">filter</span>=<span class="string">&quot;not icmp&quot;</span>, prn=<span class="keyword">lambda</span> x:x.summary())</span><br><span class="line"><span class="comment"># 将抓取到的报文的summary打印出来：</span></span><br><span class="line">sniff(<span class="built_in">filter</span>=<span class="string">&quot;icmp&quot;</span>, prn=<span class="keyword">lambda</span> x:x.summary(), count=<span class="number">10</span>)</span><br><span class="line"><span class="comment"># 将所有IP报文的源地址打印出来：</span></span><br><span class="line">sniff(<span class="built_in">filter</span>=<span class="string">&quot;icmp&quot;</span>, prn=<span class="keyword">lambda</span> x:x[IP].src, count=<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2018\09\23\AfterInstallManjaro\" rel="bookmark">配置Manjaro</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2018\09\30\howToConvert.rpmPackagesIntoArchPackages\" rel="bookmark">Manjaro系统安装.rpm或.deb软件</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2023\02\28\BfshellUsefullCmds\" rel="bookmark">Bfshell常用命令</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2022\01\23\Common_acronyms_for_data_center_network_DCN\" rel="bookmark">数据中心网络DCN常见缩写词</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2021\07\23\EthernetAndMac\" rel="bookmark">以太帧与MAC</a></div>
    </li>
  </ul>


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag"><i class="fa fa-tag"></i> Linux</a>
              <a href="/tags/Network/" rel="tag"><i class="fa fa-tag"></i> Network</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/11/30/P4PtfTest/" rel="prev" title="P4 PTF 测试简介">
                  <i class="fa fa-chevron-left"></i> P4 PTF 测试简介
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/03/10/H3CSwitchUsefullCmd/" rel="next" title="H3C交换机常用命令">
                  H3C交换机常用命令 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">haoleeson</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>




  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"bCgWJUrF9NMLpHldLlFkJNUG-gzGzoHsz","app_key":"TLdQDR7gG7YiqEflCiR8wmz3","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


  <script src="https://cdn.jsdelivr.net/npm/quicklink@2.2.0/dist/quicklink.umd.js" integrity="sha256-4kQf9z5ntdQrzsBC3YSHnEz02Z9C1UeW/E9OgnvlzSY=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":false,"archive":false,"delay":true,"timeout":3000,"priority":true,"url":"https://haoleeson.cn/2025/03/10/LinuxNetwork/"}</script>
  <script src="/js/third-party/quicklink.js"></script>

</body>
</html>
